# Turath InvenioRDM Backup and Recovery Plan (Task 2.6)

## 1. Introduction

This document outlines the backup and recovery procedures for the Turath InvenioRDM infrastructure hosted on AWS. 

As per the initial requirements, a dedicated "test host" was specified for recovery testing. However, to provide a more robust, enterprise-grade solution, the infrastructure has been implemented using **Terraform (Infrastructure-as-Code)**. In this modern architecture, the "test host" is not a static machine; instead, our recovery testing procedure involves spinning up an identical parallel environment on AWS on-demand, restoring the data, verifying integrity, and tearing it down. This guarantees that our recovery process is tested against the exact configuration used in production.

## 2. Backup Strategy (Stateful Resources)

The system relies on AWS native managed services to ensure continuous, reliable backups for all persistent data stores.

### 2.1 Relational Database (Amazon RDS PostgreSQL)
*This is the core PostgreSQL database holding all InvenioRDM metadata, users, and state.*
- **Mechanism:** AWS RDS Automated Backups.
- **Schedule:** Automated snapshots are taken daily during the maintenance window (`03:00-06:00` UTC).
- **Retention:** Backups are retained for **7 days**.
- **Point-in-Time Recovery (PITR):** Transaction logs are archived every 5 minutes, allowing database restoration to any second within the 7-day retention period.
- **Manual Snapshots:** Can be triggered on-demand before major upgrades using the provided `backup_rds_manual.sh` script.

#### 2.1.1 Snapshot Verification Before Restore
**CRITICAL:** Always verify snapshot integrity before initiating a restore operation.

**Verification Checklist:**
```bash
# 1. List available snapshots with metadata
aws rds describe-db-snapshots \
  --db-instance-identifier invenio-default-rds \
  --query 'DBSnapshots[*].[DBSnapshotIdentifier,SnapshotCreateTime,AllocatedStorage,Status]' \
  --output table

# 2. Check snapshot size (should be > 1 GB for production data)
aws rds describe-db-snapshots \
  --db-snapshot-identifier <SNAPSHOT_ID> \
  --query 'DBSnapshots[0].AllocatedStorage'

# 3. Verify snapshot timestamp aligns with expected data state
# Example: If you uploaded books at 15:00, snapshot at 14:00 won't have them
```

**Warning Signs:**
- Snapshot < 1 GB → Likely empty or partial database
- Snapshot timestamp during migration → May have incomplete schema
- Snapshot older than expected → May be missing recent records

**Best Practice:** Always take a manual snapshot AFTER completing data uploads before any risky operations.

### 2.2 File Storage (Amazon S3)
- **Mechanism:** S3 Bucket Versioning and Replication.
- **Strategy:** All uploaded files (PDFs, HOCR) are stored in the main InvenioRDM S3 bucket.
- **Manual Backup:** A secondary manual sync to a cold-storage bucket or local environment can be triggered using the `backup_s3_manual.sh` script.

### 2.3 Search Index (Amazon OpenSearch)
- **Mechanism:** The OpenSearch cluster is entirely derived from the primary RDS database.
- **Strategy:** In the event of a catastrophic failure, the OpenSearch index does not need to be restored from a snapshot. Instead, it is rebuilt natively using the InvenioRDM CLI (`invenio index rebuild`) after the RDS database is restored.

### 2.4 Infrastructure (Terraform State)
- **Mechanism:** Terraform state files (`terraform.tfstate`).
- **Strategy:** State files define the exact architecture of the platform. They are tracked locally and should be securely backed up to a dedicated S3 state bucket or version control.

### 2.5 Password Management Architecture
**CRITICAL:** Understanding password authentication is essential for recovery operations.

**Current Architecture (as of Feb 2026):**
- **Production Password:** Generated by Terraform (`random_password.rds_master_password`)
- **Storage:** Encrypted in Terraform state (not Secrets Manager)
- **Delivery:** `RDS_DB_PASSWORD` environment variable in ECS task definitions
- **Runtime Resolution:** `resolve-db-uri.sh` entrypoint script constructs database URI

**How It Works:**
1. Terraform generates 32-character random password on first `apply`
2. Password stored in ECS task definition as `RDS_DB_PASSWORD` environment variable
3. Container entrypoint (`/usr/local/bin/resolve-db-uri.sh`) reads `RDS_DB_PASSWORD`
4. Script URL-encodes password and sets `INVENIO_SQLALCHEMY_DATABASE_URI`
5. uWSGI workers inherit the environment variable

**IMPORTANT LIMITATION:**
- **CLI commands bypass entrypoint** (`invenio users create`, `invenio db upgrade`, etc.)
- These commands read config files directly, not environment variables
- **Result:** Cannot create users or run migrations via `aws ecs execute-command`
- **Workaround:** Use web UI for user creation, or direct SQL for emergency operations

**Retrieving Current Password:**
```bash
# From Terraform state
cd ~/Projects/inveniordm-terraform
terraform console <<< 'random_password.rds_master_password.result'

# From running ECS task definition
TASK_DEF=$(aws ecs describe-services \
  --cluster invenio-default-cluster \
  --services web-ui \
  --query 'services[0].taskDefinition' --output text)
aws ecs describe-task-definition --task-definition "$TASK_DEF" \
  --query 'taskDefinition.containerDefinitions[?name==`app`].environment[?name==`RDS_DB_PASSWORD`].value' \
  --output text
```

---

## 3. Stateless and Ephemeral Components (No Backup Required)

Modern cloud architecture separates stateful data from stateless compute. The following components are explicitly excluded from backups because they hold no persistent data:

- **Compute Containers (Celery Workers, Web-UI, Web-API):** Hosted on AWS ECS Fargate. If destroyed, ECS automatically pulls the latest `ghcr.io/alabarazi/turath-rdm:develop` Docker image and restarts them. 
- **Caching (Redis / ElastiCache):** Holds temporary session data and application cache. If lost, users may need to log in again, but no permanent data is lost. It boots up empty on recovery.
- **Message Queues (Amazon MQ / SQS):** Holds in-flight Celery tasks. If a task is lost during a disaster, the user simply retries the upload/action when the system recovers.

---

## 4. Recovery Procedure (The "Test Host" Methodology)

To test a recovery (or perform an actual disaster recovery), we leverage Terraform to act as our dynamic "Test Host."

### Step 1: Provision the Recovery Environment (The Test Host)
If testing recovery, initialize a new AWS workspace or use a dedicated staging VPC.
```bash
# Apply the infrastructure code to spin up a clean environment
terraform init
terraform apply -auto-approve
```

### Step 2: Restore the Database

**2.1 Verify Snapshot Before Restore (See Section 2.1.1)**

**2.2 Restore RDS Instance**
1. Identify the target RDS Snapshot ARN (either automated or manual).
2. Restore the snapshot to a new RDS instance via the AWS Console or CLI.
3. Update the `ecs-web-ui-service.tf` and `ecs-web-api-service.tf` to point the `RDS_DB_HOST` environment variable to the newly restored database endpoint.
4. **CRITICAL:** Ensure `RDS_DB_PASSWORD` in task definitions matches the restored database password.

**2.3 Apply Infrastructure Changes**
```bash
cd ~/Projects/inveniordm-terraform
terraform apply -auto-approve
```

**2.4 Force New Deployment (REQUIRED)**
⚠️ **CRITICAL STEP:** Terraform creates new task definition revisions but does NOT automatically deploy them to running services.

```bash
# Force web-ui to use new task definition with updated password
aws ecs update-service \
  --cluster invenio-default-cluster \
  --service web-ui \
  --force-new-deployment

# Force web-api to use new task definition
aws ecs update-service \
  --cluster invenio-default-cluster \
  --service web-api \
  --force-new-deployment

# Monitor deployment progress (wait ~2-3 minutes)
aws ecs describe-services \
  --cluster invenio-default-cluster \
  --services web-ui \
  --query 'services[0].deployments[0].[status,rolloutState,runningCount]'
```

**Why This Matters:**
- Without `--force-new-deployment`, containers run old task definition
- Old task definition may have wrong password or missing environment variables
- Result: 502 errors or "password authentication failed"

*(See `scripts/feature-backup-recovery/restore_rds_guide.sh` for exact CLI commands).*

### Step 3: Connect File Storage
1. Ensure the new environment's ECS tasks have IAM permissions to read from the primary S3 bucket, OR sync the primary bucket to a new recovery bucket.
2. Update the `S3_BUCKET_NAME` environment variable in Terraform if using a cloned bucket.

### Step 4: Rebuild Search Index
Once the Web UI and API containers are running and connected to the restored DB:
1. Connect to the running `web-ui` container:
   ```bash
   aws ecs execute-command --cluster invenio-default-cluster --task <TASK_ID> --container app --interactive --command "/bin/bash"
   ```
2. Destroy the old index and rebuild from the restored database:
   ```bash
   invenio index destroy --yes-i-know
   invenio index init
   invenio rdm-records rebuild-index
   ```

### Step 5: Verify Application Integrity

**5.1 Basic Connectivity**
```bash
# Test homepage
curl -k -sS -o /dev/null -w "Home: HTTP %{http_code}\n" "https://invenio.turath-project.com/"

# Test API database access
curl -k -sS "https://invenio.turath-project.com/api/records?size=1" | jq '.hits.total'

# Check logs for password success
aws logs tail /invenio-default/web-ui --since 5m | grep "resolve-db-uri"
# Expected: "[resolve-db-uri] Using RDS_DB_PASSWORD (manual password management)"
# Expected: "[resolve-db-uri] DB URI resolved successfully"
```

**5.2 Database Integrity**
```bash
# Verify users exist
aws ecs execute-command --cluster invenio-default-cluster \
  --task <TASK_ARN> --container app --interactive \
  --command 'bash -c "cd /opt/invenio/var/instance && pipenv run python -c \"from invenio_accounts.models import User; from invenio_db import db; from invenio_app.factory import create_app; app=create_app(); app.app_context().push(); print(f\\\"Users: {User.query.count()}\\\")\""

# Verify records exist
curl -k -sS "https://invenio.turath-project.com/api/records" | jq '.hits.total'
```

**5.3 Application Features**
- Navigate to the Application Load Balancer URL.
- Perform a search query to verify OpenSearch rebuilt correctly.
- Open a record and verify the Mirador viewer loads the PDF from S3.
- Test login functionality

**5.4 User Account Recovery**
If database restore was from before user accounts existed:

**Option 1: Web Self-Registration** (Recommended)
1. Visit: `https://invenio.turath-project.com/signup/`
2. Create admin account
3. Grant privileges via direct SQL (see Section 6.2)

**Option 2: Direct SQL Insert** (Advanced)
```sql
-- Only use if CLI commands fail due to password/entrypoint issues
-- See Section 6.2 for exact procedure
```

## 5. RPO and RTO Objectives
- **Recovery Point Objective (RPO):** < 5 minutes (via RDS Point-in-Time Recovery).
- **Recovery Time Objective (RTO):** ~45-60 minutes (Time to provision Terraform + restore RDS snapshot + rebuild OpenSearch index).

---

## 6. Troubleshooting Common Recovery Issues

### 6.1 Password Authentication Failed

**Symptom:**
```
FATAL: password authentication failed for user "inveniordm_user"
```

**Root Cause:**
ECS services using old task definition revision with wrong/missing `RDS_DB_PASSWORD`.

**Solution:**
1. Verify password in Terraform state:
   ```bash
   cd ~/Projects/inveniordm-terraform
   terraform console <<< 'random_password.rds_master_password.result'
   ```

2. Check if task definition has password:
   ```bash
   TASK_DEF=$(aws ecs describe-services --cluster invenio-default-cluster --services web-ui --query 'services[0].taskDefinition' --output text)
   aws ecs describe-task-definition --task-definition "$TASK_DEF" \
     --query 'taskDefinition.containerDefinitions[?name==`app`].environment[?name==`RDS_DB_PASSWORD`]'
   ```

3. If missing or wrong, apply Terraform and force deployment:
   ```bash
   terraform apply -auto-approve
   aws ecs update-service --cluster invenio-default-cluster --service web-ui --force-new-deployment
   aws ecs update-service --cluster invenio-default-cluster --service web-api --force-new-deployment
   ```

4. Verify logs:
   ```bash
   aws logs tail /invenio-default/web-ui --since 3m | grep "resolve-db-uri"
   ```

### 6.2 Empty Database After Restore

**Symptom:**
- API returns `"total": 0`
- No users can log in
- Database exists but has no data

**Root Cause:**
Restored snapshot was taken during migration or before data uploads.

**Verification:**
```bash
# Check when snapshot was created
aws rds describe-db-snapshots --db-snapshot-identifier <SNAPSHOT_ID> \
  --query 'DBSnapshots[0].SnapshotCreateTime'

# Check snapshot size (should be > 1 GB)
aws rds describe-db-snapshots --db-snapshot-identifier <SNAPSHOT_ID> \
  --query 'DBSnapshots[0].AllocatedStorage'
```

**Solution:**
1. Identify correct snapshot with data (check timestamps)
2. Restore from newer snapshot or Point-in-Time Recovery
3. If no good snapshot exists: Re-upload data from source files

### 6.3 CLI Commands Fail Inside Containers

**Symptom:**
```bash
aws ecs execute-command --command 'invenio users create ...'
# Error: password authentication failed
```

**Root Cause:**
CLI commands bypass `resolve-db-uri.sh` entrypoint and don't have access to `RDS_DB_PASSWORD`.

**Solution:**
Use web UI for user management:
1. Visit `https://invenio.turath-project.com/signup/`
2. Create account via web registration
3. Grant admin privileges via direct SQL if needed

**Alternative (Direct SQL for Emergency):**
```bash
# Only if absolutely necessary
# Connect to database directly and insert user manually
# See internal ops docs for exact SQL commands
```

### 6.4 Site Returns 502 After Restore

**Symptom:**
- Homepage loads (HTTP 200)
- `/login/` returns 502 Bad Gateway
- API endpoints return 502

**Root Cause:**
Web app can't connect to database (password issue or wrong endpoint).

**Diagnosis:**
```bash
# Check logs for database errors
aws logs tail /invenio-default/web-ui --since 10m | grep -i "password\|fatal\|error"

# Test database connectivity from web app
curl -k -sS "https://invenio.turath-project.com/api/records?size=1"
```

**Solution:** See Section 6.1 (Password Authentication Failed)

### 6.5 Deployment Stuck or Failed

**Symptom:**
```bash
aws ecs describe-services --cluster invenio-default-cluster --services web-ui
# Shows: rolloutState: FAILED or stuck IN_PROGRESS
```

**Common Causes:**
- Health check failures (container can't connect to DB)
- Wrong Docker image
- Resource constraints

**Solution:**
```bash
# Check task logs for startup errors
aws logs tail /invenio-default/web-ui --since 5m

# Force rollback if needed
aws ecs update-service --cluster invenio-default-cluster \
  --service web-ui --task-definition <PREVIOUS_GOOD_REVISION>
```

---

## 7. Lessons Learned Log

### Incident: Feb 28, 2026 - Database Restore Failure
**What Happened:**
- Restored RDS from snapshot dated Feb 27 23:15
- Snapshot was taken during password migration (empty database)
- Users and records missing after restore
- Password authentication failed due to ECS using stale task definitions

**What We Learned:**
1. **ALWAYS verify snapshot has data before restore**
2. **Terraform apply ≠ ECS deployment** (must force-new-deployment)
3. **CLI commands can't create users** (entrypoint bypass)
4. **Automated daily backups now enabled** (7-day retention)

**Permanent Fixes Applied:**
1. Enabled RDS automated backups (7 days)
2. Added snapshot verification checklist (Section 2.1.1)
3. Documented deployment workflow (Section 4.2.4)
4. Added troubleshooting guide (Section 6)
5. Updated password management documentation (Section 2.5)
