# P2-3.1: User Roles & Permissions Configuration

**Deliverable**: Updated user roles configuration  
**Milestone**: Phase 2 - User roles refined  
**Date**: February 2026  
**Status**: Implemented

## Overview

This document defines the user role structure for the Turath InvenioRDM platform, establishing clear access control and team structure based on initial usage patterns.

## Role Definitions

### 1. System Administrator (Superuser)

**Purpose**: Full system administration and technical management

**Access**:
- `/administration` panel (system configuration)
- All API endpoints (read/write)
- User management
- Role assignment
- System settings and configuration

**Responsibilities**:
- System maintenance and monitoring
- User account management
- Technical troubleshooting
- Infrastructure oversight

**How to Identify**: Users with the `admin` role and `superuser-access` permission

---

### 2. Curator / Content Manager

**Purpose**: Content ingestion, curation, and publication

**Access**:
- Record creation via API/scripts
- Record editing and metadata updates
- Record publication
- File upload and management
- Read access to all published content

**Responsibilities**:
- Ingest new books and manuscripts
- Verify and edit metadata
- Publish records for public access
- Maintain content quality

**How to Identify**: Users with the `curator` role

---

### 3. Public User (Reader)

**Purpose**: Browse and access published content

**Access**:
- Read-only access to published records
- Search functionality
- IIIF viewer (Mirador)
- Full-text search (HOCR)
- Download published files

**Restrictions**:
- Cannot create records
- Cannot edit metadata
- Cannot access unpublished drafts
- Cannot access administration panel

**How to Identify**: Any authenticated or anonymous user without special roles

---

## Permission Matrix

| Action | System Admin | Curator | Public User |
|--------|-------------|---------|-------------|
| View published records | ✅ | ✅ | ✅ |
| Search records | ✅ | ✅ | ✅ |
| View IIIF manifests | ✅ | ✅ | ✅ |
| Full-text search (HOCR) | ✅ | ✅ | ✅ |
| Create new records | ✅ | ✅ | ❌ |
| Edit metadata | ✅ | ✅ | ❌ |
| Upload files | ✅ | ✅ | ❌ |
| Publish records | ✅ | ✅ | ❌ |
| Delete records | ✅ | ⚠️ (own records) | ❌ |
| Access /administration | ✅ | ❌ | ❌ |
| Manage users | ✅ | ❌ | ❌ |
| Assign roles | ✅ | ❌ | ❌ |
| System configuration | ✅ | ❌ | ❌ |

---

## Team Structure Mapping

### Current Production Users

1. **admin@turath-project.com**
   - Role: System Administrator
   - Permissions: superuser-access, administration-access
   - Purpose: System administration and technical oversight

2. **curator@turath-project.com** (to be created)
   - Role: Curator
   - Permissions: Record creation/editing via API
   - Purpose: Content ingestion and management

---

## Implementation Details

### Roles in InvenioRDM Database

Roles are stored in the `accounts_role` table:

```sql
-- admin role
INSERT INTO accounts_role (name, description) 
VALUES ('admin', 'Administrator role');

-- curator role
INSERT INTO accounts_role (name, description) 
VALUES ('curator', 'Content curator role');
```

### Permission Assignments

Permissions are managed via InvenioRDM's access control system:

```bash
# Admin role permissions
invenio access allow superuser-access role admin
invenio access allow administration-access role admin

# User-to-role assignments
invenio roles add admin@turath-project.com admin
invenio roles add curator@turath-project.com curator
```

---

## Backend Enforcement

All role-based access control is enforced at the **backend API level**, not in the frontend UI:

1. **API Level**: REST API checks permissions before allowing operations
2. **View Level**: Flask views check user permissions
3. **Service Level**: InvenioRDM services enforce access policies

This means the custom Turath frontend (which omits "Edit" buttons) still has full security - permissions are enforced by the backend regardless of UI.

---

## How to Verify Roles

### Check User Roles
```bash
# Inside production container
pipenv run invenio roles list

# Check specific user
pipenv run invenio users list | grep admin@turath-project.com
```

### Test API Permissions
```bash
# Admin user - should succeed
curl -k -H "Authorization: Bearer $ADMIN_TOKEN" \
  https://invenio.turath-project.com/api/records

# Public user - should get 403 on protected endpoints
curl -k -H "Authorization: Bearer $PUBLIC_TOKEN" \
  https://invenio.turath-project.com/administration
```

---

## Future Extensions

### Potential Additional Roles

1. **Reviewer**: Can review pending submissions (if using Communities)
2. **Editor**: Can edit metadata but not publish
3. **Reader (restricted)**: Access to specific collections only

### InvenioRDM Communities (Optional)

InvenioRDM supports Communities for more granular access control:
- **Owner**: Full community control
- **Manager**: Moderate submissions
- **Curator**: Review and publish
- **Reader**: View community content

This can be implemented in Phase 3 if needed.

---

## Maintenance

### Adding New Curators
```bash
# Run on production
./scripts/create_curator_user.py curator2@turath-project.com
```

### Removing Roles
```bash
# Inside container
pipenv run invenio roles remove user@example.com curator
```

### Auditing Permissions
```bash
# List all users with admin role
pipenv run invenio access show role admin
```

---

## References

- InvenioRDM Access Control: https://inveniordm.docs.cern.ch/reference/access/
- InvenioRDM Communities: https://inveniordm.docs.cern.ch/customize/communities/
- Production Site: https://invenio.turath-project.com
- Implementation Scripts: `/scripts/setup_production_roles.py`

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-02-27 | Initial role structure defined | System |
| 2026-02-27 | Deployed to production | System |
